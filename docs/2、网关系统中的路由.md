# ä¼ä¸šçº§ç½‘å…³ç³»ç»ŸåŠ¨æ€è·¯ç”±å‚æ•°ä¸å®ç°æ–¹æ¡ˆ

## 1. åŠ¨æ€è·¯ç”±å‚æ•°ç»“æ„è®¾è®¡

ä¼ä¸šçº§ç½‘å…³ç³»ç»Ÿçš„åŠ¨æ€è·¯ç”±å‚æ•°åº”æ”¯æŒå¤šç»´åº¦æµé‡è°ƒåº¦ã€å¼¹æ€§æ‰©å±•ã€æ™ºèƒ½ç›‘æ§å’Œè‡ªåŠ¨åŒ–è¿ç»´ã€‚æ¨èé‡‡ç”¨å¦‚ä¸‹ç»“æ„ï¼š

```yaml
routes:
  - id: payment-core-v1
    uri: lb://payment-service-v1
    predicates:
      - Path=/api/payment/**
      - Method=POST,GET
    filters:
      - name: RequestRateLimiter
        args:
          redis-rate-limiter.replenishRate: 200
          redis-rate-limiter.burstCapacity: 300
      - name: CircuitBreaker
        args:
          name: paymentCircuitBreaker
          fallbackUri: forward:/api/fallback/payment
      - name: Retry
        args:
          retries: 2
          statuses: BAD_GATEWAY, GATEWAY_TIMEOUT
          backoff:
            firstBackoff: 100ms
            maxBackoff: 500ms
            factor: 2
      - name: Degrade
        args:
          enable: true
          fallbackUri: forward:/api/fallback/payment
    metadata:
      version: v1.0.0
      weight: 60
      priority: 10
      enable: true
      tags: [core, payment, stable]
      grayRelease: false
      canary: false
      healthStatus: UP
      maxConnections: 50
      timeout: 2000ms
      security:
        whitelist: [10.0.0.0/8, 192.168.1.0/24]
        blacklist: []
        jwtRequired: true
      monitor:
        alertThreshold:
          errorRate: 1.0
          latency: 500ms
        enableTracing: true
      custom:
        channel: "wechat"
        activityId: "20240701"
        dynamicParam: "value"
```

## 2. åŠ¨æ€è·¯ç”±å‚æ•°è¯´æ˜

| å‚æ•°å         | è¯´æ˜                                             |
| -------------- | ------------------------------------------------ |
| id             | è·¯ç”±å”¯ä¸€æ ‡è¯†                                     |
| uri            | ç›®æ ‡æœåŠ¡åœ°å€ï¼ˆæœåŠ¡å‘ç°ã€æƒé‡ã€åŠ¨æ€å˜æ›´ï¼‰         |
| predicates     | è·¯ç”±åŒ¹é…æ¡ä»¶ï¼ˆè·¯å¾„ã€æ–¹æ³•ã€Headerã€å‚æ•°ç­‰ï¼‰       |
| filters        | è·¯ç”±è¿‡æ»¤å™¨é“¾ï¼ˆé™æµã€ç†”æ–­ã€é‡è¯•ã€é™çº§ã€åŠ è§£å¯†ç­‰ï¼‰ |
| metadata       | è·¯ç”±å…ƒæ•°æ®ï¼ˆåŠ¨æ€å‚æ•°åŒºï¼Œæ”¯æŒçƒ­æ›´æ–°ï¼‰             |
| version        | è·¯ç”±/æœåŠ¡ç‰ˆæœ¬å·                                  |
| weight         | è·¯ç”±æƒé‡ï¼ˆæµé‡åˆ†é…ç”¨ï¼‰                           |
| priority       | è·¯ç”±ä¼˜å…ˆçº§                                       |
| enable         | è·¯ç”±å¼€å…³                                         |
| tags           | è·¯ç”±æ ‡ç­¾ï¼ˆå¤šç»´åº¦åˆ†æµã€ç°åº¦ã€é‡‘ä¸é›€ç­‰ï¼‰           |
| grayRelease    | æ˜¯å¦ç°åº¦å‘å¸ƒ                                     |
| canary         | æ˜¯å¦é‡‘ä¸é›€å‘å¸ƒ                                   |
| healthStatus   | å¥åº·çŠ¶æ€ï¼ˆUP/DOWN/DEGRADEDï¼‰                     |
| maxConnections | æœ€å¤§è¿æ¥æ•°/å¹¶å‘æ•°                                |
| timeout        | è·¯ç”±è¶…æ—¶æ—¶é—´                                     |
| security       | å®‰å…¨ç­–ç•¥ï¼ˆç™½åå•ã€é»‘åå•ã€JWTç­‰ï¼‰                |
| monitor        | ç›‘æ§ä¸å‘Šè­¦å‚æ•°ï¼ˆé˜ˆå€¼ã€é“¾è·¯è¿½è¸ªç­‰ï¼‰               |
| custom         | ä¸šåŠ¡è‡ªå®šä¹‰å‚æ•°ï¼ˆå¦‚æ¸ é“ã€æ´»åŠ¨IDã€åŠ¨æ€æ‰©å±•å‚æ•°ç­‰ï¼‰ |

## 3. åŠ¨æ€è·¯ç”±ç®¡ç†å®ç°æ–¹æ¡ˆ

### 3.1 é…ç½®ä¸­å¿ƒ/æ•°æ®åº“å­˜å‚¨

- è·¯ç”±å‚æ•°å­˜å‚¨äºé…ç½®ä¸­å¿ƒï¼ˆå¦‚Nacosã€Apolloã€Consulï¼‰æˆ–æ•°æ®åº“ï¼ˆå¦‚MySQLã€MongoDBï¼‰
- æ”¯æŒè·¯ç”±å‚æ•°çš„çƒ­åŠ è½½ã€ç°åº¦å‘å¸ƒã€ç‰ˆæœ¬å›æ»š

### 3.2 åŠ¨æ€è·¯ç”±APIç®¡ç†

- æä¾›RESTful APIè¿›è¡Œè·¯ç”±çš„å¢åˆ æ”¹æŸ¥ã€å¯ç”¨/ç¦ç”¨ã€æƒé‡è°ƒæ•´ã€å¥åº·çŠ¶æ€å˜æ›´ç­‰
- æ”¯æŒæ‰¹é‡æ“ä½œã€æƒé™æ§åˆ¶ã€æ“ä½œå®¡è®¡

#### åŠ¨æ€è·¯ç”±APIç¤ºä¾‹

```json
{
  "id": "user-service-gray",
  "uri": "lb://user-service-v2",
  "predicates": [
    { "name": "Path", "args": ["/api/user/**"] },
    { "name": "Header", "args": ["X-Gray-User", "true"] }
  ],
  "filters": [
    { "name": "RequestRateLimiter", "args": { "redis-rate-limiter.replenishRate": 100, "redis-rate-limiter.burstCapacity": 150 } },
    { "name": "CircuitBreaker", "args": { "name": "userCircuitBreaker", "fallbackUri": "forward:/api/fallback/user" } },
    { "name": "Retry", "args": { "retries": 1, "backoff": "200ms" } }
  ],
  "metadata": {
    "version": "v2.1.0",
    "weight": 20,
    "priority": 20,
    "enable": true,
    "tags": ["gray", "user", "canary"],
    "grayRelease": true,
    "canary": true,
    "healthStatus": "UP",
    "maxConnections": 20,
    "timeout": "1500ms",
    "security": {
      "whitelist": ["10.1.0.0/16"],
      "blacklist": ["10.1.2.3"],
      "jwtRequired": true
    },
    "monitor": {
      "alertThreshold": {
        "errorRate": 2.0,
        "latency": "800ms"
      },
      "enableTracing": true
    },
    "custom": {
      "channel": "alipay",
      "activityId": "20240702"
    }
  }
}
```

### 3.3 åŠ¨æ€å‚æ•°çƒ­æ›´æ–°æœºåˆ¶

- è·¯ç”±å‚æ•°å˜æ›´åï¼Œç½‘å…³è‡ªåŠ¨æ„ŸçŸ¥å¹¶çƒ­åŠ è½½ï¼Œæ— éœ€é‡å¯
- æ”¯æŒç°åº¦/é‡‘ä¸é›€æµé‡åŠ¨æ€åˆ‡æ¢ã€æƒé‡è°ƒæ•´ã€å¥åº·çŠ¶æ€è‡ªåŠ¨æ‘˜é™¤/æ¢å¤
- å˜æ›´æ“ä½œæœ‰å®¡è®¡æ—¥å¿—ï¼Œæ”¯æŒå›æ»š

### 3.4 ç›‘æ§ä¸å‘Šè­¦é›†æˆ

- è·¯ç”±çº§åˆ«çš„QPSã€å¤±è´¥ç‡ã€å»¶è¿Ÿã€ç†”æ–­ã€é™çº§ã€åˆ‡æ¢ã€å¥åº·ç­‰åŠ¨æ€æŒ‡æ ‡å®æ—¶é‡‡é›†
- æ”¯æŒPrometheusã€Grafanaç­‰å¯è§†åŒ–ç›‘æ§å’Œè‡ªåŠ¨å‘Šè­¦

### 3.5 å®‰å…¨ä¸åˆè§„

- è·¯ç”±çº§åˆ«çš„é»‘ç™½åå•ã€è®¤è¯ã€åŠ è§£å¯†ã€æ•æ„Ÿæ•°æ®ä¿æŠ¤ç­‰åŠ¨æ€å®‰å…¨ç­–ç•¥
- å˜æ›´æ“ä½œæƒé™æ§åˆ¶ä¸å®¡è®¡ï¼Œæ»¡è¶³é‡‘èçº§åˆè§„è¦æ±‚

## 4. æœ€ä½³å®è·µ

1. **æ‰€æœ‰åŠ¨æ€å‚æ•°æ”¯æŒçƒ­æ›´æ–°**ï¼Œæ— éœ€é‡å¯ç½‘å…³
2. **å¤šç»´åº¦æµé‡è°ƒåº¦**ï¼Œå¦‚æƒé‡ã€æ ‡ç­¾ã€ç”¨æˆ·ã€åœ°åŸŸã€æ¸ é“ç­‰
3. **ç›‘æ§ä¸å‘Šè­¦å‚æ•°å¯åŠ¨æ€è°ƒæ•´**ï¼Œä¾¿äºè¿ç»´å®æ—¶å“åº”
4. **å®‰å…¨ç­–ç•¥åŠ¨æ€å¯æ§**ï¼Œå¦‚é»‘ç™½åå•ã€åŠ è§£å¯†ã€è®¤è¯æ–¹å¼ç­‰
5. **æ”¯æŒè‡ªå®šä¹‰æ‰©å±•å‚æ•°**ï¼Œæ»¡è¶³ä¸šåŠ¡å¿«é€Ÿå˜åŒ–éœ€æ±‚
6. **æ‰€æœ‰å˜æ›´æœ‰å®¡è®¡æ—¥å¿—**ï¼Œä¾¿äºè¿½æº¯å’Œå›æ»š
7. **ä¸é…ç½®ä¸­å¿ƒ/æ•°æ®åº“/è¿ç»´å¹³å°æ·±åº¦é›†æˆ**ï¼Œå®ç°è‡ªåŠ¨åŒ–è¿ç»´å’Œå¼¹æ€§æ‰©å±•

---

åŠ¨æ€è·¯ç”±å‚æ•°ç»“æ„è®¾è®¡ï¼ˆYAML/JSONæ ·ä¾‹ï¼Œæ¶µç›–æƒé‡ã€ä¼˜å…ˆçº§ã€å¥åº·ã€é™æµã€ç†”æ–­ã€ç°åº¦ã€æ ‡ç­¾ã€ç›‘æ§ã€å®‰å…¨ã€æ‰©å±•ç­‰ï¼‰
å‚æ•°è¯¦ç»†è¯´æ˜è¡¨
åŠ¨æ€è·¯ç”±ç®¡ç†å®ç°æ–¹æ¡ˆï¼ˆé…ç½®ä¸­å¿ƒ/æ•°æ®åº“ã€APIç®¡ç†ã€çƒ­æ›´æ–°æœºåˆ¶ã€ç›‘æ§å‘Šè­¦ã€å®‰å…¨åˆè§„ç­‰ï¼‰
ä¼ä¸šçº§æœ€ä½³å®è·µå»ºè®®
è¯¥æ–‡æ¡£å¯ç›´æ¥ä½œä¸ºä¼ä¸šçº§ç½‘å…³ç³»ç»ŸåŠ¨æ€è·¯ç”±å‚æ•°è®¾è®¡å’Œè½åœ°çš„å‚è€ƒæ ‡å‡†ã€‚å¦‚éœ€å…·ä½“ä»£ç å®ç°ã€APIæ¥å£æ–‡æ¡£æˆ–

é€šè¿‡ä¸Šè¿°ä¼ä¸šçº§åŠ¨æ€è·¯ç”±å‚æ•°ç»“æ„å’Œå®ç°æ–¹æ¡ˆï¼Œç½‘å…³ç³»ç»Ÿå¯å®ç°é«˜å¯ç”¨ã€é«˜å¼¹æ€§ã€é«˜å¯è§‚æµ‹å’Œé«˜å®‰å…¨çš„æµé‡è°ƒåº¦èƒ½åŠ›ï¼Œæ»¡è¶³é‡‘èçº§ã€æ”¯ä»˜çº§ä¸šåŠ¡çš„ä¸¥è‹›è¦æ±‚ã€‚



# ğŸ›£ï¸ ç½‘å…³è·¯ç”±ç®¡ç†å®ç°æ€»ç»“

## ğŸ“‹ è·¯ç”±ç®¡ç†æ¶æ„æ¦‚è§ˆ

å½“å‰ç½‘å…³é¡¹ç›®å®ç°äº†ä¸€å¥—**å®Œæ•´çš„è·¯ç”±ç®¡ç†ä½“ç³»**ï¼ŒåŒ…å«é™æ€è·¯ç”±é…ç½®ã€åŠ¨æ€è·¯ç”±ç®¡ç†ã€é«˜çº§è´Ÿè½½å‡è¡¡ã€è·¯ç”±ç›‘æ§ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæ”¯æŒé«˜å¯ç”¨ã€é«˜å¹¶å‘çš„ä¼ä¸šçº§ç½‘å…³éœ€æ±‚ã€‚

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶æ¶æ„

### 1. **é™æ€è·¯ç”±é…ç½®** âš™ï¸

#### **RoutesConfig - é™æ€è·¯ç”±é…ç½®**

```java
@Configuration
public class RoutesConfig {
    @Bean
    public RouteLocator routes(RouteLocatorBuilder builder) {
        return builder.routes()
            // æ”¯ä»˜æœåŠ¡è·¯ç”± - æ ¸å¿ƒAPI
            .route("payment-route", r -> r
                .path("/api/gateway/payment/**")
                .filters(f -> f
                    .rewritePath("/api/gateway/payment/(?<segment>.*)", "/api/payment/${segment}")
                    .filter(advancedRateLimitFilter)     // 1. é™æµè¿‡æ»¤å™¨
                    .filter(serviceDegradationGatewayFilter) // 2. æœåŠ¡é™çº§è¿‡æ»¤å™¨
                    .filter(circuitBreakerFilter)        // 3. ç†”æ–­å™¨è¿‡æ»¤å™¨
                    .filter(cryptoFilter)               // 4. åŠ è§£å¯†è¿‡æ»¤å™¨
                )
                .uri("http://localhost:8081")
            )
            // å…¶ä»–æœåŠ¡è·¯ç”±...
            .build();
    }
}
```

#### **è·¯ç”±åˆ†ç±»ä¸ä¼˜å…ˆçº§**

- **æ ¸å¿ƒæœåŠ¡**ï¼šæ”¯ä»˜æœåŠ¡ã€è´¦æˆ·æœåŠ¡ã€è½¬è´¦æœåŠ¡
- **é‡è¦æœåŠ¡**ï¼šç”¨æˆ·æœåŠ¡
- **æ™®é€šæœåŠ¡**ï¼šæŸ¥è¯¢æœåŠ¡ã€æµ‹è¯•æœåŠ¡
- **éæ ¸å¿ƒæœåŠ¡**ï¼šç»Ÿè®¡æœåŠ¡

### 2. **åŠ¨æ€è·¯ç”±ç®¡ç†** ğŸ”„

#### **DynamicRouteService - åŠ¨æ€è·¯ç”±æœåŠ¡**

```java
@Service
public class DynamicRouteService {
    // è·¯ç”±å¢åˆ æ”¹æŸ¥
    public Mono<Boolean> addRoute(DynamicRouteDefinition routeDef);
    public Mono<Boolean> updateRoute(DynamicRouteDefinition routeDef);
    public Mono<Boolean> deleteRoute(String routeId);
    public Mono<List<DynamicRouteDefinition>> getAllRoutes();
  
    // è·¯ç”±ç»Ÿè®¡
    public Map<String, RouteStats> getRouteStats();
    public void updateRouteStats(String routeId, boolean success, long responseTime);
  
    // ç‰ˆæœ¬ç®¡ç†
    public long getRouteVersion();
    public void incrementRouteVersion();
}
```

#### **DynamicRouteDefinition - åŠ¨æ€è·¯ç”±å®šä¹‰**

```java
public static class DynamicRouteDefinition {
    private String id;                    // è·¯ç”±ID
    private String name;                  // è·¯ç”±åç§°
    private String description;           // è·¯ç”±æè¿°
    private List<String> predicates;      // æ–­è¨€åˆ—è¡¨
    private List<String> filters;         // è¿‡æ»¤å™¨åˆ—è¡¨
    private String uri;                   // ç›®æ ‡URI
    private int order;                    // è·¯ç”±é¡ºåº
    private boolean enabled;              // æ˜¯å¦å¯ç”¨
    private Map<String, Object> metadata; // å…ƒæ•°æ®
    private String serviceLevel;          // æœåŠ¡çº§åˆ«
    private int weight;                   // æƒé‡
    private String loadBalancerStrategy;  // è´Ÿè½½å‡è¡¡ç­–ç•¥
    private int timeout;                  // è¶…æ—¶æ—¶é—´
    private int retryCount;               // é‡è¯•æ¬¡æ•°
    private boolean circuitBreakerEnabled; // æ˜¯å¦å¯ç”¨ç†”æ–­å™¨
    private boolean rateLimitEnabled;     // æ˜¯å¦å¯ç”¨é™æµ
    private int qps;                      // QPSé™åˆ¶
    private String fallbackUri;           // é™çº§URI
}
```

#### **DynamicRouteController - åŠ¨æ€è·¯ç”±API**

```java
@RestController
@RequestMapping("/api/gateway/routes")
public class DynamicRouteController {
    @PostMapping - æ·»åŠ è·¯ç”±
    @PutMapping("/{routeId}") - æ›´æ–°è·¯ç”±
    @DeleteMapping("/{routeId}") - åˆ é™¤è·¯ç”±
    @GetMapping - è·å–æ‰€æœ‰è·¯ç”±
    @GetMapping("/stats") - è·å–è·¯ç”±ç»Ÿè®¡
    @GetMapping("/version") - è·å–è·¯ç”±ç‰ˆæœ¬
    @PostMapping("/batch") - æ‰¹é‡æ›´æ–°è·¯ç”±
    @PostMapping("/refresh") - åˆ·æ–°è·¯ç”±é…ç½®
}
```

### 3. **é«˜çº§è´Ÿè½½å‡è¡¡** âš–ï¸

#### **AdvancedLoadBalancer - é«˜çº§è´Ÿè½½å‡è¡¡å™¨**

```java
@Component
public class AdvancedLoadBalancer {
    // è´Ÿè½½å‡è¡¡ç­–ç•¥
    public enum LoadBalancingStrategy {
        ROUND_ROBIN,        // è½®è¯¢
        WEIGHTED_ROUND_ROBIN, // æƒé‡è½®è¯¢
        LEAST_CONNECTIONS,  // æœ€å°‘è¿æ¥
        RESPONSE_TIME,      // å“åº”æ—¶é—´
        CONSISTENT_HASH,    // ä¸€è‡´æ€§å“ˆå¸Œ
        RANDOM,            // éšæœº
        IP_HASH            // IPå“ˆå¸Œ
    }
  
    // å®ä¾‹é€‰æ‹©
    public Mono<ServiceInstance> chooseInstance(String serviceName, String requestId);
  
    // ç»Ÿè®¡ç®¡ç†
    public void updateResponseTime(String serviceName, String instanceId, long responseTime);
    public ServiceInstanceStats getStats(String serviceName);
}
```

#### **LoadBalancerFilter - è´Ÿè½½å‡è¡¡è¿‡æ»¤å™¨**

```java
@Component
public class LoadBalancerFilter extends AbstractGatewayFilterFactory<LoadBalancerFilter.Config> {
    // é›†æˆåˆ°ç½‘å…³è·¯ç”±ä¸­
    // æ”¯æŒåŠ¨æ€è´Ÿè½½å‡è¡¡ç­–ç•¥åˆ‡æ¢
    // æä¾›å®æ—¶ç»Ÿè®¡ä¿¡æ¯
}
```

#### **LoadBalancerController - è´Ÿè½½å‡è¡¡ç®¡ç†API**

```java
@RestController
@RequestMapping("/api/gateway/loadbalancer")
public class LoadBalancerController {
    @PostMapping("/strategy") - è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥
    @PostMapping("/refresh") - åˆ·æ–°æœåŠ¡å®ä¾‹
    @GetMapping("/stats/{serviceName}") - è·å–æœåŠ¡ç»Ÿè®¡
    @GetMapping("/strategies") - è·å–å¯ç”¨ç­–ç•¥
    @PostMapping("/test") - æµ‹è¯•è´Ÿè½½å‡è¡¡
}
```

## ğŸ“Š è·¯ç”±é…ç½®è¯¦è§£

### 1. **é™æ€è·¯ç”±é…ç½®**

#### **æœåŠ¡çº§åˆ«è·¯ç”±é…ç½®**

```yaml
# æ ¸å¿ƒæœåŠ¡é…ç½®
core-service:
  service-level: CORE
  weight: 100
  load-balancer-strategy: WEIGHTED_ROUND_ROBIN
  timeout: 5000
  retry-count: 3
  circuit-breaker-enabled: true
  rate-limit-enabled: true
  qps: 100

# é‡è¦æœåŠ¡é…ç½®
important-service:
  service-level: IMPORTANT
  weight: 80
  load-balancer-strategy: LEAST_CONNECTIONS
  timeout: 3000
  retry-count: 2
  circuit-breaker-enabled: true
  rate-limit-enabled: true
  qps: 80

# æ™®é€šæœåŠ¡é…ç½®
normal-service:
  service-level: NORMAL
  weight: 50
  load-balancer-strategy: ROUND_ROBIN
  timeout: 2000
  retry-count: 1
  circuit-breaker-enabled: true
  rate-limit-enabled: true
  qps: 50

# éæ ¸å¿ƒæœåŠ¡é…ç½®
non-core-service:
  service-level: NON_CORE
  weight: 20
  load-balancer-strategy: RANDOM
  timeout: 1000
  retry-count: 0
  circuit-breaker-enabled: false
  rate-limit-enabled: true
  qps: 20
```

#### **è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåº**

```java
// æ ¸å¿ƒæœåŠ¡è¿‡æ»¤å™¨é¡ºåº
1. advancedRateLimitFilter        // é™æµè¿‡æ»¤å™¨
2. serviceDegradationGatewayFilter // æœåŠ¡é™çº§è¿‡æ»¤å™¨ï¼ˆå‰ç½®ï¼‰
3. circuitBreakerFilter           // ç†”æ–­å™¨è¿‡æ»¤å™¨
4. cryptoFilter                   // åŠ è§£å¯†è¿‡æ»¤å™¨

// æ™®é€šæœåŠ¡è¿‡æ»¤å™¨é¡ºåº
1. advancedRateLimitFilter        // é™æµè¿‡æ»¤å™¨
2. circuitBreakerFilter           // ç†”æ–­å™¨è¿‡æ»¤å™¨
3. serviceDegradationGatewayFilter // æœåŠ¡é™çº§è¿‡æ»¤å™¨ï¼ˆåç½®ï¼‰
```

### 2. **åŠ¨æ€è·¯ç”±é…ç½®**

#### **åŠ¨æ€è·¯ç”±é…ç½®**

```yaml
gateway:
  dynamic-route:
    # å­˜å‚¨ç±»å‹ï¼šmemory, file
    storage-type: memory
  
    # æ–‡ä»¶é…ç½®
    file:
      path: config/routes.yml
      auto-reload: true
      reload-interval-ms: 5000
  
    # ç¼“å­˜é…ç½®
    cache:
      max-size: 1000
      expire-seconds: 300
      enable-stats: true
  
    # ç›‘æ§é…ç½®
    monitor:
      enable-metrics: true
      stats-interval-ms: 60000
      enable-health-check: true
      health-check-interval-ms: 30000
```

#### **åŠ¨æ€è·¯ç”±ç¤ºä¾‹**

```yaml
spring:
  cloud:
    gateway:
      routes:
        # æ”¯ä»˜æœåŠ¡åŠ¨æ€è·¯ç”±
        - id: payment-dynamic-route
          uri: lb://payment-service
          predicates:
            - Path=/api/payment/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
            - name: CircuitBreaker
              args:
                name: payment-circuit-breaker
                fallbackUri: forward:/fallback/payment
          metadata:
            service-level: CORE
            weight: 100
            load-balancer-strategy: WEIGHTED_ROUND_ROBIN
            timeout: 5000
            retry-count: 3
            circuit-breaker-enabled: true
            rate-limit-enabled: true
            qps: 100
            fallback-uri: forward:/fallback/payment
```

## ğŸ”„ åŠ¨æ€è·¯ç”±æµç¨‹

### 1. **è·¯ç”±æ·»åŠ æµç¨‹**

```text
1. æ¥æ”¶è·¯ç”±å®šä¹‰è¯·æ±‚
   â†“
2. éªŒè¯è·¯ç”±å®šä¹‰æœ‰æ•ˆæ€§
   â†“
3. æ£€æŸ¥è·¯ç”±IDæ˜¯å¦å·²å­˜åœ¨
   â†“
4. è½¬æ¢ä¸ºRouteDefinitionå¯¹è±¡
   â†“
5. ä¿å­˜åˆ°å­˜å‚¨å±‚
   â†“
6. æ›´æ–°å†…å­˜ç¼“å­˜
   â†“
7. å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶
   â†“
8. è¿”å›æ“ä½œç»“æœ
```

### 2. **è·¯ç”±æ›´æ–°æµç¨‹**

```
1. æ¥æ”¶è·¯ç”±æ›´æ–°è¯·æ±‚
   â†“
2. éªŒè¯è·¯ç”±å®šä¹‰æœ‰æ•ˆæ€§
   â†“
3. æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨
   â†“
4. åˆ é™¤æ—§è·¯ç”±å®šä¹‰
   â†“
5. ä¿å­˜æ–°è·¯ç”±å®šä¹‰
   â†“
6. æ›´æ–°å†…å­˜ç¼“å­˜
   â†“
7. å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶ï¼Œä½¿ç”¨redis å‘å¸ƒè®¢é˜…ï¼Œç¡®ä¿å¤šå¤ªå®ä¾‹éƒ½èƒ½è·å–æœ€æ–°é…ç½®ã€‚
   â†“
8. è¿”å›æ“ä½œç»“æœ
```

### 3. **è·¯ç”±åˆ é™¤æµç¨‹**

```
1. æ¥æ”¶è·¯ç”±åˆ é™¤è¯·æ±‚
   â†“
2. æ£€æŸ¥è·¯ç”±æ˜¯å¦å­˜åœ¨
   â†“
3. ä»å­˜å‚¨å±‚åˆ é™¤è·¯ç”±
   â†“
4. ä»å†…å­˜ç¼“å­˜åˆ é™¤
   â†“
5. å‘å¸ƒè·¯ç”±åˆ·æ–°äº‹ä»¶
   â†“
6. è¿”å›æ“ä½œç»“æœ
```

## âš–ï¸ è´Ÿè½½å‡è¡¡ç­–ç•¥è¯¦è§£

### 1. **è½®è¯¢ç­–ç•¥ (Round Robin)**

```java
private ServiceInstance selectRoundRobin(List<ServiceInstance> instances) {
    ServiceInstanceStats stats = getOrCreateStats("default");
    int index = (int) (stats.getRoundRobinCounter().incrementAndGet() % instances.size());
    return instances.get(index);
}
```

**ç‰¹ç‚¹ï¼š** è¯·æ±‚æŒ‰é¡ºåºåˆ†é…ç»™æ¯ä¸ªå®ä¾‹ï¼Œç®€å•å…¬å¹³

### 2. **æƒé‡è½®è¯¢ç­–ç•¥ (Weighted Round Robin)**

```java
private ServiceInstance selectWeightedRoundRobin(List<ServiceInstance> instances) {
    // æ ¹æ®å®ä¾‹æƒé‡åˆ†é…è¯·æ±‚
    // æ”¯æŒæ€§èƒ½å·®å¼‚è¾ƒå¤§çš„å®ä¾‹
}
```

**ç‰¹ç‚¹ï¼š** æ ¹æ®å®ä¾‹æƒé‡åˆ†é…è¯·æ±‚ï¼Œæ”¯æŒæ€§èƒ½å·®å¼‚

### 3. **æœ€å°‘è¿æ¥ç­–ç•¥ (Least Connections)**

```java
private ServiceInstance selectLeastConnections(List<ServiceInstance> instances) {
    // é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹
    // åŠ¨æ€å¹³è¡¡å®ä¾‹è´Ÿè½½
}
```

**ç‰¹ç‚¹ï¼š** é€‰æ‹©å½“å‰è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹ï¼Œé€‚åˆé•¿è¿æ¥åœºæ™¯

### 4. **å“åº”æ—¶é—´ç­–ç•¥ (Response Time)**

```java
private ServiceInstance selectBestResponseTime(List<ServiceInstance> instances) {
    // é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹
    // åŠ¨æ€è°ƒæ•´ï¼Œé€‚åº”æ€§èƒ½å˜åŒ–
}
```

**ç‰¹ç‚¹ï¼š** é€‰æ‹©å“åº”æ—¶é—´æœ€çŸ­çš„å®ä¾‹ï¼Œå¯¹å“åº”æ—¶é—´æ•æ„Ÿ

### 5. **ä¸€è‡´æ€§å“ˆå¸Œç­–ç•¥ (Consistent Hash)**

```java
private ServiceInstance selectConsistentHash(List<ServiceInstance> instances, String requestId) {
    // ç›¸åŒè¯·æ±‚IDæ€»æ˜¯è·¯ç”±åˆ°ç›¸åŒå®ä¾‹
    // æ”¯æŒä¼šè¯ä¿æŒ
}
```

**ç‰¹ç‚¹ï¼š** ç›¸åŒè¯·æ±‚IDæ€»æ˜¯è·¯ç”±åˆ°ç›¸åŒå®ä¾‹ï¼Œæ”¯æŒä¼šè¯ä¿æŒ

### 6. **éšæœºç­–ç•¥ (Random)**

```java
private ServiceInstance selectRandom(List<ServiceInstance> instances) {
    // å®Œå…¨éšæœºåˆ†é…
    // å®ç°ç®€å•
}
```

**ç‰¹ç‚¹ï¼š** å®Œå…¨éšæœºåˆ†é…ï¼Œå®ç°ç®€å•

## ğŸ“ˆ è·¯ç”±ç›‘æ§ä¸ç»Ÿè®¡

### 1. **è·¯ç”±ç»Ÿè®¡ä¿¡æ¯**

```java
public static class RouteStats {
    private String routeId;           // è·¯ç”±ID
    private long totalRequests;       // æ€»è¯·æ±‚æ•°
    private long successRequests;     // æˆåŠŸè¯·æ±‚æ•°
    private long failedRequests;      // å¤±è´¥è¯·æ±‚æ•°
    private double avgResponseTime;   // å¹³å‡å“åº”æ—¶é—´
    private LocalDateTime lastAccessTime; // æœ€åè®¿é—®æ—¶é—´
    private String status;            // è·¯ç”±çŠ¶æ€
    private Map<String, Long> errorCounts; // é”™è¯¯ç»Ÿè®¡
}
```

### 2. **è´Ÿè½½å‡è¡¡ç»Ÿè®¡ä¿¡æ¯**

```java
public static class ServiceInstanceStats {
    private final AtomicLong roundRobinCounter = new AtomicLong(0);
    private final AtomicLong currentWeight = new AtomicLong(0);
    private final AtomicLong maxWeight = new AtomicLong(1);
    private final AtomicInteger currentIndex = new AtomicInteger(-1);
    private final Map<String, AtomicLong> connectionCounts = new ConcurrentHashMap<>();
    private final Map<String, AtomicLong> requestCounts = new ConcurrentHashMap<>();
    private final Map<String, AtomicLong> responseTimes = new ConcurrentHashMap<>();
}
```

### 3. **ç›‘æ§æŒ‡æ ‡**

- **è¯·æ±‚é‡æŒ‡æ ‡**ï¼šæ€»è¯·æ±‚æ•°ã€æˆåŠŸè¯·æ±‚æ•°ã€å¤±è´¥è¯·æ±‚æ•°
- **æ€§èƒ½æŒ‡æ ‡**ï¼šå¹³å‡å“åº”æ—¶é—´ã€æœ€å¤§å“åº”æ—¶é—´ã€æœ€å°å“åº”æ—¶é—´
- **é”™è¯¯æŒ‡æ ‡**ï¼šé”™è¯¯ç±»å‹ç»Ÿè®¡ã€é”™è¯¯ç‡
- **å¯ç”¨æ€§æŒ‡æ ‡**ï¼šè·¯ç”±çŠ¶æ€ã€å¥åº·æ£€æŸ¥ç»“æœ
- **è´Ÿè½½å‡è¡¡æŒ‡æ ‡**ï¼šå®ä¾‹åˆ†å¸ƒã€è¿æ¥æ•°ã€å“åº”æ—¶é—´

## ğŸ”§ APIæ¥å£

### 1. **åŠ¨æ€è·¯ç”±ç®¡ç†æ¥å£**

#### è·å–æ‰€æœ‰è·¯ç”±

```http
GET /api/gateway/routes
```

#### æ ¹æ®IDè·å–è·¯ç”±

```http
GET /api/gateway/routes/{routeId}
```

#### æ·»åŠ è·¯ç”±

```http
POST /api/gateway/routes
Content-Type: application/json

{
  "id": "new-service-route",
  "name": "æ–°æœåŠ¡è·¯ç”±",
  "uri": "lb://new-service",
  "predicates": ["Path=/api/new/**"],
  "filters": ["StripPrefix=1"],
  "metadata": {
    "service-level": "NORMAL",
    "weight": 50
  }
}
```

#### æ›´æ–°è·¯ç”±

```http
PUT /api/gateway/routes/{routeId}
Content-Type: application/json

{
  "uri": "lb://updated-service",
  "metadata": {
    "service-level": "IMPORTANT",
    "weight": 80
  }
}
```

#### åˆ é™¤è·¯ç”±

```http
DELETE /api/gateway/routes/{routeId}
```

#### å¯ç”¨/ç¦ç”¨è·¯ç”±

```http
PATCH /api/gateway/routes/{routeId}/toggle?enabled=true
```

### 2. **è´Ÿè½½å‡è¡¡ç®¡ç†æ¥å£**

#### è®¾ç½®è´Ÿè½½å‡è¡¡ç­–ç•¥

```http
POST /api/gateway/loadbalancer/strategy?serviceName=payment-service&strategy=WEIGHTED_ROUND_ROBIN
```

#### åˆ·æ–°æœåŠ¡å®ä¾‹

```http
POST /api/gateway/loadbalancer/refresh?serviceName=payment-service
```

#### è·å–æœåŠ¡ç»Ÿè®¡

```http
GET /api/gateway/loadbalancer/stats/payment-service
```

#### æµ‹è¯•è´Ÿè½½å‡è¡¡

```http
POST /api/gateway/loadbalancer/test?serviceName=payment-service&requestCount=10
```

### 3. **ç»Ÿè®¡ä¿¡æ¯æ¥å£**

#### è·å–è·¯ç”±ç»Ÿè®¡

```http
GET /api/gateway/routes/stats
```

#### è·å–è·¯ç”±ç‰ˆæœ¬

```http
GET /api/gateway/routes/version
```

#### æ‰¹é‡æ›´æ–°è·¯ç”±

```http
POST /api/gateway/routes/batch
Content-Type: application/json

[
  {
    "id": "route1",
    "uri": "lb://service1"
  },
  {
    "id": "route2",
    "uri": "lb://service2"
  }
]
```

#### åˆ·æ–°è·¯ç”±é…ç½®

```http
POST /api/gateway/routes/refresh
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### 1. **ç¼“å­˜ç­–ç•¥**

- **è·¯ç”±ç¼“å­˜**ï¼šä½¿ç”¨ConcurrentHashMapç¼“å­˜è·¯ç”±å®šä¹‰
- **å®ä¾‹ç¼“å­˜**ï¼šç¼“å­˜æœåŠ¡å®ä¾‹åˆ—è¡¨ï¼Œå‡å°‘æœåŠ¡å‘ç°è°ƒç”¨
- **ç»Ÿè®¡ç¼“å­˜**ï¼šç¼“å­˜ç»Ÿè®¡ä¿¡æ¯ï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½

### 2. **å¼‚æ­¥å¤„ç†**

- **å¼‚æ­¥è·¯ç”±æ“ä½œ**ï¼šè·¯ç”±å¢åˆ æ”¹æŸ¥ä½¿ç”¨å“åº”å¼ç¼–ç¨‹
- **å¼‚æ­¥è´Ÿè½½å‡è¡¡**ï¼šå®ä¾‹é€‰æ‹©ä½¿ç”¨å¼‚æ­¥å¤„ç†
- **å¼‚æ­¥ç»Ÿè®¡æ›´æ–°**ï¼šç»Ÿè®¡ä¿¡æ¯å¼‚æ­¥æ›´æ–°

### 3. **è¿æ¥æ± ä¼˜åŒ–**

```java
// è¿æ¥æ± é…ç½®
ConnectionProvider connectionProvider = ConnectionProvider.builder(name)
    .maxConnections(maxConnections)
    .maxIdleTime(Duration.ofMillis(maxIdleTime))
    .maxLifeTime(Duration.ofMinutes(5))
    .pendingAcquireTimeout(Duration.ofMillis(acquireTimeout))
    .pendingAcquireMaxCount(maxConnections * 2)
    .metrics(true)
    .build();
```

### 4. **å†…å­˜ç®¡ç†**

- **åŠæ—¶é‡Šæ”¾**ï¼šè·¯ç”±åˆ é™¤æ—¶åŠæ—¶é‡Šæ”¾å†…å­˜
- **ç¼“å­˜æ¸…ç†**ï¼šå®šæœŸæ¸…ç†è¿‡æœŸç¼“å­˜
- **å†…å­˜ç›‘æ§**ï¼šå®æ—¶ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ›¡ï¸ é«˜å¯ç”¨ä¿éšœ

### 1. **æ•…éšœæ¢å¤**

- **è·¯ç”±é™çº§**ï¼šè·¯ç”±æ•…éšœæ—¶è‡ªåŠ¨é™çº§
- **å®ä¾‹å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥å®ä¾‹å¥åº·çŠ¶æ€
- **è‡ªåŠ¨é‡è¯•**ï¼šå¤±è´¥è¯·æ±‚è‡ªåŠ¨é‡è¯•

### 2. **è´Ÿè½½ä¿æŠ¤**

- **é™æµä¿æŠ¤**ï¼šé˜²æ­¢è¿‡è½½
- **ç†”æ–­ä¿æŠ¤**ï¼šé˜²æ­¢çº§è”æ•…éšœ
- **é™çº§ä¿æŠ¤**ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶é™çº§å¤„ç†

### 3. **ç›‘æ§å‘Šè­¦**

- **è·¯ç”±çŠ¶æ€ç›‘æ§**ï¼šå®æ—¶ç›‘æ§è·¯ç”±çŠ¶æ€
- **æ€§èƒ½æŒ‡æ ‡ç›‘æ§**ï¼šç›‘æ§å“åº”æ—¶é—´ã€ååé‡
- **é”™è¯¯ç‡ç›‘æ§**ï¼šç›‘æ§é”™è¯¯ç‡å’Œå¼‚å¸¸

## ğŸ“‹ é…ç½®ç¤ºä¾‹

### 1. **å®Œæ•´è·¯ç”±é…ç½®ç¤ºä¾‹**

```yaml
# åº”ç”¨é…ç½®
spring:
  application:
    name: api-gateway
  
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
  
      routes:
        # æ”¯ä»˜æœåŠ¡è·¯ç”±
        - id: payment-route
          uri: lb://payment-service
          predicates:
            - Path=/api/payment/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
            - name: CircuitBreaker
              args:
                name: payment-circuit-breaker
                fallbackUri: forward:/fallback/payment
          metadata:
            service-level: CORE
            weight: 100
            load-balancer-strategy: WEIGHTED_ROUND_ROBIN
            timeout: 5000
            retry-count: 3
            circuit-breaker-enabled: true
            rate-limit-enabled: true
            qps: 100
            fallback-uri: forward:/fallback/payment

# åŠ¨æ€è·¯ç”±é…ç½®
gateway:
  dynamic-route:
    storage-type: memory
    file:
      path: config/routes.yml
      auto-reload: true
      reload-interval-ms: 5000
    cache:
      max-size: 1000
      expire-seconds: 300
      enable-stats: true
    monitor:
      enable-metrics: true
      stats-interval-ms: 60000
      enable-health-check: true
      health-check-interval-ms: 30000

# è´Ÿè½½å‡è¡¡é…ç½®
ribbon:
  ConnectTimeout: 2000
  ReadTimeout: 5000
  MaxAutoRetries: 1
  MaxAutoRetriesNextServer: 1
  OkToRetryOnAllOperations: false

# ç†”æ–­å™¨é…ç½®
resilience4j:
  circuitbreaker:
    instances:
      payment-circuit-breaker:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 3

# ç›‘æ§é…ç½®
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
      base-path: /actuator
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: true
```

## ğŸ¯ æ€»ç»“

å½“å‰ç½‘å…³é¡¹ç›®å®ç°äº†ä¸€å¥—**ä¼ä¸šçº§çš„è·¯ç”±ç®¡ç†ä½“ç³»**ï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### âœ… **è·¯ç”±ç‰¹æ€§**

1. **é™æ€è·¯ç”±**ï¼šåŸºäºé…ç½®çš„é™æ€è·¯ç”±å®šä¹‰
2. **åŠ¨æ€è·¯ç”±**ï¼šæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€å¢åˆ æ”¹æŸ¥
3. **è´Ÿè½½å‡è¡¡**ï¼šå¤šç§è´Ÿè½½å‡è¡¡ç­–ç•¥æ”¯æŒ
4. **æœåŠ¡å‘ç°**ï¼šé›†æˆæœåŠ¡æ³¨å†Œä¸å‘ç°
5. **è·¯ç”±ç›‘æ§**ï¼šå®Œæ•´çš„è·¯ç”±ç›‘æ§å’Œç»Ÿè®¡

### âœ… **æ€§èƒ½ç‰¹æ€§**

1. **é«˜æ€§èƒ½**ï¼šç¼“å­˜ä¼˜åŒ–ï¼Œå¼‚æ­¥å¤„ç†
2. **é«˜å¯ç”¨**ï¼šæ•…éšœæ¢å¤ï¼Œè´Ÿè½½ä¿æŠ¤
3. **é«˜å¹¶å‘**ï¼šè¿æ¥æ± ä¼˜åŒ–ï¼ŒèƒŒå‹æ§åˆ¶
4. **é«˜æ‰©å±•**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼Œæ’ä»¶åŒ–æ¶æ„

### âœ… **è¿ç»´ç‰¹æ€§**

1. **æ˜“ç®¡ç†**ï¼šREST APIï¼Œé…ç½®åŒ–
2. **æ˜“ç›‘æ§**ï¼šå®æ—¶ç›‘æ§ï¼Œå®¡è®¡æ—¥å¿—
3. **æ˜“æ‰©å±•**ï¼šåŠ¨æ€é…ç½®ï¼Œçƒ­æ›´æ–°
4. **æ˜“ç»´æŠ¤**ï¼šç‰ˆæœ¬ç®¡ç†ï¼Œå›æ»šæ”¯æŒ

è¿™å¥—è·¯ç”±ç®¡ç†ä½“ç³»ä¸ºç½‘å…³ç³»ç»Ÿæä¾›äº†**å…¨æ–¹ä½çš„è·¯ç”±ç®¡ç†èƒ½åŠ›**ï¼Œæ»¡è¶³ä¼ä¸šçº§åº”ç”¨çš„è·¯ç”±éœ€æ±‚ï¼Œæ”¯æŒé«˜å¹¶å‘ã€é«˜å¯ç”¨çš„ä¸šåŠ¡åœºæ™¯ã€‚

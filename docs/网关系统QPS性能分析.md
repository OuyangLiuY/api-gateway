# 网关系统QPS性能分析

## 系统资源分析

### 1. **硬件资源配置**
- **CPU核心数**：2核
- **内存配置**：1GB堆内存（512MB初始，1GB最大）
- **网络配置**：标准网络带宽
- **存储配置**：本地存储

### 2. **线程池配置分析**

#### 核心API线程池
```java
coreApiThreadPool:
- 核心线程数：16 (2核 × 8)
- 最大线程数：18 (16 + 2)
- 队列大小：80
- 总处理能力：16线程 × 并发处理
```

#### 普通API线程池
```java
normalApiThreadPool:
- 核心线程数：6 (2核 × 3)
- 最大线程数：8 (6 + 2)
- 队列大小：20
- 总处理能力：6线程 × 并发处理
```

#### 加解密线程池
```java
cryptoExecutor:
- 核心线程数：2 (2核 × 1)
- 最大线程数：4 (2 + 2)
- 队列大小：100
- 总处理能力：2线程 × 并发处理
```

#### 默认线程池
```java
defaultThreadPool:
- 核心线程数：2 (2核 × 1)
- 最大线程数：4 (2 + 2)
- 队列大小：10
- 总处理能力：2线程 × 并发处理
```

### 3. **连接池配置分析**

#### WebClient连接池
```yaml
总连接数：52个连接
- 核心服务：25个连接
- 重要服务：15个连接
- 普通服务：8个连接
- 非核心服务：4个连接
```

#### Netty连接池
```yaml
- IO工作线程：2个
- 最大连接数：52个
- 获取超时：3000ms
```

## QPS限制因素分析

### 1. **CPU限制**
- **2核CPU理论极限**：约2000-4000 QPS（取决于请求复杂度）
- **实际可用QPS**：受限于线程池配置和业务逻辑复杂度

### 2. **线程池限制**
- **总线程数**：16 + 6 + 2 + 2 = 26个核心线程
- **线程利用率**：假设80%利用率，有效线程约21个
- **单线程QPS**：假设每个线程处理50-100 QPS

### 3. **连接池限制**
- **总连接数**：52个连接
- **连接复用率**：假设0.3的连接复用系数
- **有效并发连接**：约156个并发请求（52 ÷ 0.3）

### 4. **内存限制**
- **堆内存**：1GB
- **对象创建开销**：每个请求约1-2KB内存
- **GC影响**：G1GC，最大暂停时间200ms

## 当前配置下的QPS估算

### 1. **理论QPS计算**

#### 基于线程池的QPS
```
总QPS = 总线程数 × 单线程QPS × 线程利用率
总QPS = 26 × 75 × 0.8 = 1,560 QPS
```

#### 基于连接池的QPS
```
总QPS = 有效并发连接 × 连接复用率 × 响应时间系数
总QPS = 156 × 0.3 × (1000ms / 200ms) = 234 QPS
```

#### 基于CPU的QPS
```
总QPS = CPU核心数 × 单核QPS × CPU利用率
总QPS = 2 × 1000 × 0.8 = 1,600 QPS
```

### 2. **实际QPS限制**

#### 限流配置限制
```yaml
API权重总QPS：
- 核心服务：40 QPS
- 重要服务：30 QPS
- 普通服务：20 QPS
- 非核心服务：10 QPS
总计：100 QPS
```

#### 单层限流限制
```yaml
- IP限流：30 QPS
- 用户限流：20 QPS
- URL限流：40 QPS
```

### 3. **瓶颈分析**

#### 主要瓶颈
1. **限流配置**：API权重总QPS限制为100
2. **连接池**：52个连接限制了并发处理能力
3. **线程池**：26个核心线程限制了并行处理能力
4. **内存**：1GB堆内存限制了对象缓存和处理

#### 次要瓶颈
1. **CPU核心数**：2核限制了并行处理能力
2. **网络带宽**：可能成为高并发时的瓶颈
3. **磁盘IO**：日志写入可能影响性能

## 最大QPS估算

### 1. **保守估算（基于当前配置）**
- **最大QPS**：100 QPS
- **依据**：API权重限流配置的总和
- **说明**：这是系统设计时的目标QPS

### 2. **理论最大QPS（移除限流）**
- **最大QPS**：1,000-1,500 QPS
- **依据**：基于线程池和CPU能力的理论计算
- **说明**：需要调整限流配置和优化系统参数

### 3. **实际可达到的QPS**
- **稳定QPS**：80-100 QPS
- **峰值QPS**：120-150 QPS（短暂）
- **依据**：考虑系统稳定性和资源利用率

## 性能优化建议

### 1. **短期优化（配置调整）**

#### 提高限流配置
```yaml
api-weights:
  CORE:
    qps: 100                   # 从40提升到100
  IMPORTANT:
    qps: 80                    # 从30提升到80
  NORMAL:
    qps: 60                    # 从20提升到60
  NON_CORE:
    qps: 40                    # 从10提升到40
总计：280 QPS
```

#### 增加连接池配置
```yaml
connection-pool:
  core-service:
    max-connections: 50        # 从25增加到50
  important-service:
    max-connections: 30        # 从15增加到30
  normal-service:
    max-connections: 20        # 从8增加到20
  non-core-service:
    max-connections: 10        # 从4增加到10
总计：110个连接
```

### 2. **中期优化（架构调整）**

#### 增加线程池配置
```java
coreApiThreadPool:
- 核心线程数：32 (2核 × 16)
- 最大线程数：40
- 队列大小：200

normalApiThreadPool:
- 核心线程数：16 (2核 × 8)
- 最大线程数：20
- 队列大小：100
```

#### 优化内存配置
```yaml
jvm:
  memory:
    initial-heap-size: 2g      # 从512MB增加到2GB
    max-heap-size: 4g          # 从1GB增加到4GB
```

### 3. **长期优化（硬件升级）**

#### 硬件升级建议
- **CPU**：升级到4核或8核
- **内存**：升级到8GB或16GB
- **网络**：升级到千兆网络
- **存储**：使用SSD存储

#### 架构优化建议
- **集群部署**：多实例负载均衡
- **缓存优化**：增加Redis集群
- **数据库优化**：读写分离，连接池优化

## 性能测试建议

### 1. **压力测试场景**
```bash
# 基础压力测试
ab -n 10000 -c 100 http://gateway:8080/api/test/qps/api/test1

# 并发压力测试
ab -n 50000 -c 200 http://gateway:8080/api/test/qps/api/test1

# 长时间稳定性测试
ab -n 100000 -c 50 -t 300 http://gateway:8080/api/test/qps/api/test1
```

### 2. **监控指标**
- **响应时间**：P50、P95、P99
- **错误率**：HTTP 5xx错误率
- **资源使用率**：CPU、内存、网络
- **线程池状态**：活跃线程数、队列大小
- **连接池状态**：活跃连接数、等待连接数

### 3. **性能基准**
- **目标QPS**：100 QPS（当前配置）
- **目标响应时间**：<200ms（P95）
- **目标错误率**：<0.1%
- **目标资源使用率**：CPU <80%，内存 <80%

## 总结

### 当前系统QPS能力
- **设计QPS**：100 QPS（基于限流配置）
- **理论最大QPS**：1,000-1,500 QPS（基于硬件能力）
- **实际稳定QPS**：80-100 QPS
- **峰值QPS**：120-150 QPS（短暂）

### 主要限制因素
1. **限流配置**：API权重总QPS限制为100
2. **硬件资源**：2核CPU、1GB内存限制了处理能力
3. **连接池**：52个连接限制了并发处理
4. **线程池**：26个核心线程限制了并行处理

### 优化建议
1. **短期**：调整限流配置，可提升到280 QPS
2. **中期**：优化线程池和内存配置，可提升到500-800 QPS
3. **长期**：硬件升级和架构优化，可提升到1000+ QPS

当前网关系统在2核CPU、1GB内存的配置下，最大支持约100 QPS的稳定处理能力，通过配置优化可以提升到280 QPS，通过硬件升级可以进一步提升到1000+ QPS。 
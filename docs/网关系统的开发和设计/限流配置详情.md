# API网关限流配置详情

## 📋 配置概述

基于系统最高QPS为100的限制，设计了多层次、多维度的限流策略，确保系统稳定运行且合理分配资源。

## 🎯 核心原则

1. **总QPS不超过100**：所有限流策略的总和不能超过系统最大承载能力
2. **保证核心业务**：核心API（支付、转账）优先保证可用性
3. **分层防护**：IP、用户、URL、权重四层限流协同工作
4. **合理分配**：根据业务重要性和资源消耗分配配额

## 📊 限流配置参数

### 全局配置
```yaml
gateway:
  rate-limit:
    enabled: true
    # 全局默认限流配置 - 作为兜底保护
    default-qps: 80
    default-burst: 120
```

### 1. IP限流配置
```yaml
# IP限流配置 - 防止单个IP攻击，保护系统整体
ip-limit-enabled: true
ip-qps: 30          # 单个IP每秒最多30个请求
ip-burst: 50        # 突发流量允许50个请求
```

**设计思路**：
- 防止单个IP恶意攻击
- 保护系统整体稳定性
- 允许正常用户的突发流量

### 2. 用户限流配置
```yaml
# 用户限流配置 - 防止单个用户过度使用
user-limit-enabled: true
user-qps: 20        # 单个用户每秒最多20个请求
user-burst: 35      # 突发流量允许35个请求
```

**设计思路**：
- 防止单个用户过度使用系统资源
- 基于JWT token或用户ID识别
- 支持正常用户的突发操作

### 3. URL路径限流配置
```yaml
# URL路径限流配置 - 防止热点API被过度调用
url-limit-enabled: true
url-qps: 40         # 单个URL每秒最多40个请求
url-burst: 60       # 突发流量允许60个请求
```

**设计思路**：
- 防止热点API被恶意刷取
- 保护特定接口不被过度调用
- 基于HTTP方法和路径进行限流

### 4. API权重限流配置
```yaml
# API权重限流配置 - 根据业务重要性分配资源
api-weight-limit-enabled: true
api-weights:
  CORE:             # 核心API：支付、转账等关键业务
    qps: 60         # 占用60%的系统资源
    burst: 80
    weight: 1.0
  NORMAL:           # 普通API：一般业务查询
    qps: 25         # 占用25%的系统资源
    burst: 35
    weight: 0.4
  NON_CORE:         # 非核心API：统计、报表等
    qps: 10         # 占用10%的系统资源
    burst: 15
    weight: 0.2
  CRYPTO:           # 加解密API：特殊处理
    qps: 15         # 占用15%的系统资源
    burst: 20
    weight: 0.3
```

## 📈 资源分配策略

| 限流类型 | QPS配置 | 占比 | 设计思路 |
|---------|---------|------|----------|
| **API权重限流** | 60+25+10+15 = 110 | 110% | 允许轻微超载，实际执行时取最小值 |
| **IP限流** | 30 | 30% | 防止单个IP攻击 |
| **用户限流** | 20 | 20% | 防止单个用户过度使用 |
| **URL限流** | 40 | 40% | 防止热点API被过度调用 |
| **全局兜底** | 80 | 80% | 系统整体保护 |

## 🔄 执行逻辑

### 限流检查顺序
1. **IP限流检查**：`当前IP请求数 <= 30`
2. **用户限流检查**：`当前用户请求数 <= 20`
3. **URL限流检查**：`当前URL请求数 <= 40`
4. **API权重限流检查**：`当前优先级可用令牌 > 0`

### 最终QPS计算
```
最终QPS = min(IP限流, 用户限流, URL限流, API权重限流, 全局限流)
```

## 🎭 典型场景分析

### 场景1：正常业务流量
- **描述**：多个用户访问不同API
- **实际QPS**：≈ 60-80（核心业务为主）
- **系统状态**：稳定运行
- **限流效果**：各层限流协同工作，保证系统稳定

### 场景2：核心业务高峰期
- **描述**：支付、转账请求激增
- **核心API QPS**：达到60
- **其他API**：自动降级
- **限流效果**：优先保证核心业务可用性

### 场景3：恶意攻击
- **描述**：单个IP大量请求
- **IP限流**：30 QPS生效
- **保护效果**：保护系统整体稳定
- **响应**：返回429状态码，建议60秒后重试

### 场景4：热点API被刷
- **描述**：某个URL被大量调用
- **URL限流**：40 QPS生效
- **保护效果**：防止热点API影响其他服务
- **响应**：返回429状态码，建议60秒后重试

## 📊 API优先级分类

### CORE（核心API）- 60 QPS
- **业务类型**：支付、转账、提现、存款、账户创建/关闭
- **API路径示例**：
  - `/api/payment/process`
  - `/api/transfer`
  - `/api/withdraw`
  - `/api/deposit`
  - `/api/account/create`
  - `/api/account/close`
- **权重**：1.0（最高优先级）
- **资源占比**：60%

### NORMAL（普通API）- 25 QPS
- **业务类型**：账户余额查询、交易历史、用户资料、通知
- **API路径示例**：
  - `/api/account/balance`
  - `/api/transaction/history`
  - `/api/user/profile`
  - `/api/notification`
- **权重**：0.4（中等优先级）
- **资源占比**：25%

### NON_CORE（非核心API）- 10 QPS
- **业务类型**：统计、报表、分析、日志、对账单
- **API路径示例**：
  - `/api/statistics`
  - `/api/reports`
  - `/api/analytics`
  - `/api/logs`
  - `/api/statement`
- **权重**：0.2（低优先级）
- **资源占比**：10%

### CRYPTO（加解密API）- 15 QPS
- **业务类型**：数据加解密、密钥管理
- **API路径示例**：
  - `/api/crypto/encrypt`
  - `/api/crypto/decrypt`
  - `/api/crypto/key`
- **权重**：0.3（特殊优先级）
- **资源占比**：15%

## 🔧 监控和告警

### 监控指标
建议监控以下指标来验证配置效果：
- 各层限流的触发次数
- 被限流的请求分布
- 核心API的可用性
- 系统整体QPS

### 告警设置
建议设置以下告警：
- **核心API限流触发率 > 10%**
- **系统整体QPS > 80**
- **熔断器开启状态**
- **IP限流触发频率异常**

### 监控接口
- `GET /api/gateway/monitor/circuit-breakers` - 熔断器状态
- `GET /api/gateway/monitor/rate-limiters` - 限流器状态
- `GET /api/gateway/monitor/api-statistics` - API统计信息
- `GET /api/gateway/monitor/health` - 系统健康状态

## 🚀 配置优化建议

### 1. 动态调整
根据实际运行情况，可以动态调整：
- **核心API权重**：可以适当提高（如70%）
- **非核心API权重**：可以进一步降低（如5%）
- **IP限流**：可以根据正常用户行为调整

### 2. 性能优化
- 使用本地缓存（Caffeine）提高限流检查性能
- 令牌桶算法支持突发流量处理
- 异步处理减少响应延迟

### 3. 扩展性考虑
- 支持Redis实现分布式限流
- 支持配置中心动态调整参数
- 支持自定义限流策略

## 📝 配置验证

### 测试场景
1. **正常流量测试**：验证各层限流正常工作
2. **压力测试**：验证系统在极限情况下的表现
3. **异常场景测试**：验证限流防护效果
4. **恢复测试**：验证限流恢复机制

### 验证指标
- 限流触发准确性
- 系统响应时间
- 错误率控制
- 资源利用率

## 🔒 安全考虑

### 防护机制
- **DDoS防护**：IP限流防止分布式攻击
- **API滥用防护**：用户限流防止恶意调用
- **热点防护**：URL限流防止热点API被刷
- **资源保护**：权重限流保证核心业务可用

### 响应策略
- **429状态码**：请求过多时返回
- **Retry-After头**：建议重试时间
- **X-RateLimit-Type头**：标识限流类型
- **详细错误信息**：便于问题排查

---

*本文档基于系统最高QPS 100的限制设计，确保在保证核心业务可用性的同时，有效防护各种异常情况。* 
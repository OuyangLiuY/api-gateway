# é™æµæ’é˜Ÿæœºåˆ¶å®ç°æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

ä¼ ç»Ÿçš„é™æµæœºåˆ¶åœ¨æµé‡è¶…å‡ºé™åˆ¶æ—¶ç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œè¿™å¯èƒ½å¯¼è‡´ç”¨æˆ·ä½“éªŒä¸ä½³ã€‚æ’é˜Ÿé™æµæœºåˆ¶é€šè¿‡å°†è¶…é™çš„è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†ï¼Œåœ¨ä¿æŠ¤ç³»ç»Ÿçš„åŒæ—¶æå‡ç”¨æˆ·ä½“éªŒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **æå‡ç”¨æˆ·ä½“éªŒ**ï¼šé¿å…ç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œæä¾›æ’é˜Ÿç­‰å¾…æœºåˆ¶
2. **ä¿æŠ¤ç³»ç»Ÿèµ„æº**ï¼šé€šè¿‡é˜Ÿåˆ—æ§åˆ¶å¹¶å‘å¤„ç†æ•°é‡
3. **æ”¯æŒä¼˜å…ˆçº§**ï¼šVIPç”¨æˆ·å’Œæ ¸å¿ƒAPIä¼˜å…ˆå¤„ç†
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒä¸åŒåœºæ™¯çš„é˜Ÿåˆ—é…ç½®
5. **ç›‘æ§ç®¡ç†**ï¼šæä¾›å®Œæ•´çš„ç›‘æ§å’Œç®¡ç†åŠŸèƒ½

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

```
è¯·æ±‚ â†’ [QueuedRateLimitFilter] â†’ [QueuedRateLimiter] â†’ [é˜Ÿåˆ—] â†’ [å¤„ç†å™¨] â†’ å“åº”
                â†“
        [ä¼˜å…ˆçº§åˆ¤æ–­] â†’ [é™æµæ£€æŸ¥] â†’ [é˜Ÿåˆ—ç®¡ç†]
```

### ç»„ä»¶è¯´æ˜

1. **QueuedRateLimitFilter**ï¼šæ’é˜Ÿé™æµè¿‡æ»¤å™¨ï¼Œé›†æˆåˆ°ç½‘å…³è¿‡æ»¤é“¾
2. **QueuedRateLimiter**ï¼šæ’é˜Ÿé™æµå™¨æ ¸å¿ƒé€»è¾‘
3. **QueueConfig**ï¼šé˜Ÿåˆ—é…ç½®ï¼Œæ”¯æŒå¤§å°ã€è¶…æ—¶ã€å¹¶å‘ç­‰å‚æ•°
4. **QueuedRequest**ï¼šæ’é˜Ÿè¯·æ±‚åŒ…è£…å™¨ï¼ŒåŒ…å«ä¼˜å…ˆçº§ä¿¡æ¯

## âš™ï¸ é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®

```yaml
rate:
  limit:
    queue:
      enabled: true              # æ˜¯å¦å¯ç”¨æ’é˜Ÿæœºåˆ¶
      max-size: 1000             # æœ€å¤§é˜Ÿåˆ—å¤§å°
      max-wait-time: 30000       # æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
      max-concurrency: 10        # æœ€å¤§å¹¶å‘å¤„ç†æ•°
      enable-priority: true      # æ˜¯å¦å¯ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—
```

### é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| enabled | true | æ˜¯å¦å¯ç”¨æ’é˜Ÿæœºåˆ¶ |
| max-size | 1000 | å•ä¸ªé˜Ÿåˆ—æœ€å¤§å¤§å° |
| max-wait-time | 30000 | è¯·æ±‚æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ |
| max-concurrency | 10 | æœ€å¤§å¹¶å‘å¤„ç†æ•° |
| enable-priority | true | æ˜¯å¦å¯ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ— |

## ğŸ¨ ä¼˜å…ˆçº§è®¾è®¡

### ä¼˜å…ˆçº§åˆ†ç±»

```java
// APIä¼˜å…ˆçº§ï¼ˆåŸºç¡€ä¼˜å…ˆçº§ï¼‰
CORE -> 0      // æ ¸å¿ƒAPIï¼šæ”¯ä»˜ã€è½¬è´¦ç­‰
CRYPTO -> 3    // åŠ è§£å¯†API
NORMAL -> 5    // æ™®é€šAPIï¼šæŸ¥è¯¢ã€ç»Ÿè®¡ç­‰
NON_CORE -> 8  // éæ ¸å¿ƒAPIï¼šæ—¥å¿—ã€æŠ¥è¡¨ç­‰

// ç”¨æˆ·ä¼˜å…ˆçº§è°ƒæ•´
VIPç”¨æˆ·ï¼šä¼˜å…ˆçº§ -2ï¼ˆæå‡ä¼˜å…ˆçº§ï¼‰
æ™®é€šç”¨æˆ·ï¼šä¼˜å…ˆçº§ä¸å˜
```

### ä¼˜å…ˆçº§è®¡ç®—

```java
int basePriority = switch (apiPriority) {
    case CORE -> 0;      // æœ€é«˜ä¼˜å…ˆçº§
    case CRYPTO -> 3;    // åŠ è§£å¯†ä¼˜å…ˆçº§
    case NORMAL -> 5;    // ä¸­ç­‰ä¼˜å…ˆçº§
    case NON_CORE -> 8;  // ä½ä¼˜å…ˆçº§
};

// VIPç”¨æˆ·æå‡ä¼˜å…ˆçº§
if (isVipUser(userId)) {
    basePriority = Math.max(0, basePriority - 2);
}
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. è¯·æ±‚å¤„ç†æµç¨‹

```
1. è¯·æ±‚åˆ°è¾¾ QueuedRateLimitFilter
2. æ£€æŸ¥æ˜¯å¦å¯ç”¨æ’é˜Ÿæœºåˆ¶
3. ç¡®å®šè¯·æ±‚ä¼˜å…ˆçº§
4. æ‰§è¡Œé™æµæ£€æŸ¥
   â”œâ”€ é€šè¿‡ï¼šç›´æ¥å¤„ç†è¯·æ±‚
   â””â”€ è¶…é™ï¼šè¿›å…¥æ’é˜Ÿæµç¨‹
5. æ’é˜Ÿå¤„ç†
   â”œâ”€ é˜Ÿåˆ—æœªæ»¡ï¼šåŠ å…¥é˜Ÿåˆ—
   â””â”€ é˜Ÿåˆ—å·²æ»¡ï¼šæ‹’ç»è¯·æ±‚
6. é˜Ÿåˆ—å¤„ç†å™¨å®šæœŸå¤„ç†è¯·æ±‚
7. è¿”å›å¤„ç†ç»“æœ
```

### 2. é˜Ÿåˆ—å¤„ç†æµç¨‹

```
1. å®šæœŸæ£€æŸ¥é˜Ÿåˆ—ï¼ˆæ¯100msï¼‰
2. æ£€æŸ¥è¯·æ±‚æ˜¯å¦è¶…æ—¶
   â”œâ”€ è¶…æ—¶ï¼šç§»é™¤å¹¶æ ‡è®°å¤±è´¥
   â””â”€ æœªè¶…æ—¶ï¼šç»§ç»­å¤„ç†
3. æŒ‰ä¼˜å…ˆçº§å¤„ç†è¯·æ±‚
4. æ§åˆ¶å¹¶å‘æ•°é‡
5. æ‰§è¡Œå®é™…è¯·æ±‚å¤„ç†
6. è¿”å›ç»“æœç»™å®¢æˆ·ç«¯
```

## ğŸ“Š ç›‘æ§æŒ‡æ ‡

### ç»Ÿè®¡ä¿¡æ¯

```java
public class QueueStats {
    private long totalQueuedRequests;    // æ€»æ’é˜Ÿè¯·æ±‚æ•°
    private long totalProcessedRequests; // æ€»å¤„ç†è¯·æ±‚æ•°
    private long totalRejectedRequests;  // æ€»æ‹’ç»è¯·æ±‚æ•°
    private long totalTimeoutRequests;   // æ€»è¶…æ—¶è¯·æ±‚æ•°
    private int activeQueues;            // æ´»è·ƒé˜Ÿåˆ—æ•°
    private int activeProcessors;        // æ´»è·ƒå¤„ç†å™¨æ•°
}
```

### å¥åº·æŒ‡æ ‡

```java
// æ‹’ç»ç‡
double rejectionRate = totalRejectedRequests / totalQueuedRequests;

// è¶…æ—¶ç‡
double timeoutRate = totalTimeoutRequests / totalQueuedRequests;

// å¥åº·çŠ¶æ€
String healthStatus = "HEALTHY";
if (rejectionRate > 0.1) healthStatus = "WARNING";
if (rejectionRate > 0.3) healthStatus = "CRITICAL";
```

## ğŸ› ï¸ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨

```java
@Autowired
private QueuedRateLimiter queuedRateLimiter;

// åˆ›å»ºé˜Ÿåˆ—é…ç½®
QueueConfig config = new QueueConfig(1000, Duration.ofSeconds(30), 10, true);

// æ‰§è¡Œå¸¦æ’é˜Ÿçš„é™æµæ£€æŸ¥
Mono<Void> result = queuedRateLimiter.rateLimitWithQueue(
    "api:payment",           // é˜Ÿåˆ—é”®
    () -> processRequest(),  // è¯·æ±‚å¤„ç†å‡½æ•°
    () -> checkRateLimit(),  // é™æµæ£€æŸ¥å‡½æ•°
    config,                  // é˜Ÿåˆ—é…ç½®
    0                        // ä¼˜å…ˆçº§
);
```

### 2. è¿‡æ»¤å™¨é›†æˆ

```java
@Component
public class QueuedRateLimitFilter implements GatewayFilter {
    
    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        // åˆ›å»ºæ’é˜Ÿé…ç½®
        QueueConfig config = new QueueConfig(maxQueueSize, maxWaitTime, maxConcurrency, enablePriority);
        
        // ç¡®å®šä¼˜å…ˆçº§
        int priority = getRequestPriority(path, userId);
        
        // ä½¿ç”¨æ’é˜Ÿé™æµå™¨
        return queuedRateLimiter.rateLimitWithQueue(
            generateQueueKey(clientIp, userId, method, path),
            () -> chain.filter(exchange),
            () -> checkRateLimit(exchange, clientIp, userId, method, path),
            config,
            priority
        );
    }
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. é˜Ÿåˆ—å¤§å°ä¼˜åŒ–

```yaml
# é«˜å¹¶å‘åœºæ™¯
rate:
  limit:
    queue:
      max-size: 5000          # å¢å¤§é˜Ÿåˆ—å¤§å°
      max-concurrency: 20     # å¢å¤§å¹¶å‘æ•°
      max-wait-time: 60000    # å»¶é•¿ç­‰å¾…æ—¶é—´

# ä½å»¶è¿Ÿåœºæ™¯
rate:
  limit:
    queue:
      max-size: 500           # å‡å°é˜Ÿåˆ—å¤§å°
      max-concurrency: 5      # å‡å°å¹¶å‘æ•°
      max-wait-time: 10000    # ç¼©çŸ­ç­‰å¾…æ—¶é—´
```

### 2. å†…å­˜ä¼˜åŒ–

```java
// ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—é˜²æ­¢å†…å­˜æº¢å‡º
BlockingQueue<QueuedRequest<?>> queue = new LinkedBlockingQueue<>(maxSize);

// å®šæœŸæ¸…ç†è¿‡æœŸè¯·æ±‚
executor.scheduleWithFixedDelay(() -> {
    cleanupExpiredRequests();
}, 0, 1000, TimeUnit.MILLISECONDS);
```

### 3. å¤„ç†å™¨ä¼˜åŒ–

```java
// ä½¿ç”¨ä¸“ç”¨çº¿ç¨‹æ± 
ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor(r -> {
    Thread t = new Thread(r, "queue-processor-" + key);
    t.setDaemon(true);
    return t;
});
```

## ğŸ”§ ç®¡ç†æ¥å£

### 1. ç»Ÿè®¡ä¿¡æ¯

```bash
GET /api/gateway/queue/stats
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "filterStats": {
    "queuedRequests": 150,
    "processedRequests": 120,
    "rejectedRequests": 5,
    "queueEnabled": true,
    "maxQueueSize": 1000,
    "maxWaitTimeMs": 30000,
    "maxConcurrency": 10,
    "enablePriority": true
  },
  "queueStats": {
    "totalQueuedRequests": 150,
    "totalProcessedRequests": 120,
    "totalRejectedRequests": 5,
    "totalTimeoutRequests": 2,
    "activeQueues": 3,
    "activeProcessors": 3
  },
  "timestamp": 1640995200000
}
```

### 2. é˜Ÿåˆ—çŠ¶æ€

```bash
GET /api/gateway/queue/status/{key}
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "queueStatus": {
    "key": "ip:192.168.1.100:url:GET:/api/payment",
    "queueSize": 25,
    "hasProcessor": true
  },
  "timestamp": 1640995200000
}
```

### 3. å¥åº·æ£€æŸ¥

```bash
GET /api/gateway/queue/health
```

å“åº”ç¤ºä¾‹ï¼š
```json
{
  "status": "HEALTHY",
  "rejectionRate": 0.05,
  "timeoutRate": 0.02,
  "activeQueues": 3,
  "activeProcessors": 3,
  "totalQueuedRequests": 150,
  "totalProcessedRequests": 120,
  "timestamp": 1640995200000
}
```

### 4. é˜Ÿåˆ—ç®¡ç†

```bash
# æ¸…ç©ºæŒ‡å®šé˜Ÿåˆ—
DELETE /api/gateway/queue/clear/{key}

# æ¸…ç©ºæ‰€æœ‰é˜Ÿåˆ—
DELETE /api/gateway/queue/clear-all

# æµ‹è¯•æ’é˜ŸåŠŸèƒ½
POST /api/gateway/queue/test
{
  "key": "test-queue",
  "priority": 5,
  "delay": 1000
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å†…å­˜ç®¡ç†

- é˜Ÿåˆ—å¤§å°ä¸å®œè¿‡å¤§ï¼Œé¿å…å†…å­˜æº¢å‡º
- å®šæœŸæ¸…ç†è¿‡æœŸè¯·æ±‚
- ç›‘æ§é˜Ÿåˆ—å†…å­˜ä½¿ç”¨æƒ…å†µ

### 2. è¶…æ—¶å¤„ç†

- è®¾ç½®åˆç†çš„ç­‰å¾…è¶…æ—¶æ—¶é—´
- è¶…æ—¶è¯·æ±‚è¦åŠæ—¶æ¸…ç†
- é¿å…è¯·æ±‚é•¿æ—¶é—´ç­‰å¾…

### 3. ä¼˜å…ˆçº§è®¾è®¡

- ä¼˜å…ˆçº§ä¸å®œè¿‡å¤šï¼Œå»ºè®®3-5ä¸ªçº§åˆ«
- VIPç”¨æˆ·ä¼˜å…ˆçº§æå‡è¦é€‚åº¦
- é¿å…ä¼˜å…ˆçº§æ»¥ç”¨

### 4. ç›‘æ§å‘Šè­¦

- ç›‘æ§é˜Ÿåˆ—å¤§å°å’Œç­‰å¾…æ—¶é—´
- è®¾ç½®æ‹’ç»ç‡å’Œè¶…æ—¶ç‡å‘Šè­¦
- å®šæœŸæ£€æŸ¥é˜Ÿåˆ—å¥åº·çŠ¶æ€

## ğŸš€ æ‰©å±•åŠŸèƒ½

### 1. åˆ†å¸ƒå¼é˜Ÿåˆ—

```java
// ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—
@Component
public class RedisQueuedRateLimiter extends QueuedRateLimiter {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Override
    protected BlockingQueue<QueuedRequest<?>> getOrCreateQueue(String key, QueueConfig config) {
        // ä½¿ç”¨Redis Listå®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—
        return new RedisBlockingQueue<>(redisTemplate, key, config.getMaxQueueSize());
    }
}
```

### 2. åŠ¨æ€é…ç½®

```java
// æ”¯æŒåŠ¨æ€è°ƒæ•´é˜Ÿåˆ—é…ç½®
@Component
public class DynamicQueueConfig {
    
    @RefreshScope
    @ConfigurationProperties("rate.limit.queue")
    public QueueConfig getQueueConfig() {
        return new QueueConfig(maxSize, maxWaitTime, maxConcurrency, enablePriority);
    }
}
```

### 3. é˜Ÿåˆ—åˆ†ç‰‡

```java
// æŒ‰ç”¨æˆ·IDåˆ†ç‰‡é˜Ÿåˆ—
private String getShardedQueueKey(String baseKey, String userId) {
    int shard = Math.abs(userId.hashCode()) % 16;
    return baseKey + ":shard:" + shard;
}
```

## ğŸ“ æ€»ç»“

æ’é˜Ÿé™æµæœºåˆ¶é€šè¿‡å°†è¶…é™è¯·æ±‚æ”¾å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†ï¼Œåœ¨ä¿æŠ¤ç³»ç»Ÿèµ„æºçš„åŒæ—¶æå‡äº†ç”¨æˆ·ä½“éªŒã€‚è¯¥æœºåˆ¶æ”¯æŒä¼˜å…ˆçº§å¤„ç†ã€çµæ´»é…ç½®ã€å®Œæ•´ç›‘æ§ï¼Œé€‚ç”¨äºé«˜å¹¶å‘åœºæ™¯ä¸‹çš„é™æµéœ€æ±‚ã€‚

å…³é”®ä¼˜åŠ¿ï¼š
1. **ç”¨æˆ·ä½“éªŒå‹å¥½**ï¼šé¿å…ç›´æ¥æ‹’ç»è¯·æ±‚
2. **ç³»ç»Ÿèµ„æºä¿æŠ¤**ï¼šæ§åˆ¶å¹¶å‘å¤„ç†æ•°é‡
3. **ä¼˜å…ˆçº§æ”¯æŒ**ï¼šVIPç”¨æˆ·å’Œæ ¸å¿ƒAPIä¼˜å…ˆ
4. **çµæ´»é…ç½®**ï¼šæ”¯æŒä¸åŒåœºæ™¯éœ€æ±‚
5. **å®Œæ•´ç›‘æ§**ï¼šæä¾›ç»Ÿè®¡å’Œç®¡ç†åŠŸèƒ½ 